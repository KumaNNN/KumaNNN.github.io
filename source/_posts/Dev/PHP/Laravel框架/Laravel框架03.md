---
title: Laravel框架03
date: 2019-02-28 12:36:17
updated: 2019-02-28 12:36:17 
mathjax: false
categories: 
tags:
typora-root-url: imgs
typora-copy-images-to: imgs
top: 1
---


# 一、==Eloquent ORM模型==

## 1、什么是ORM模型

> ORM是对象关系映射【Object Relational Mapping】，是一种面向对象的数据库操作数据的技术。
>
> **对象**，指的就是项目中实际的数据模型Model。
>
> **关系**，指的就是关系型数据库的数据表记录。
>
> **映射**，是指通过逻辑代码把数据表的字段和模型对象的属性，进行 一 一 对应的关联关系。
>
> 这种技术的核心是把数据表中的每一行数据记录都转换成一个数据对象的属性。
>
> 那么，操作数据对象的属性，就可以直接操作数据表中的每一行数据了。
>
> 简而言之，就是通过面向对象的方式来操作数据。

图示：

![1539218063502](1539218063502.png)

## 2、创建模型(ORM模型)

> Laravel框架中的模型基于DB查询构造器来实现的，所以在我们自定义模型中就算什么方法都不写，也可以直接调用到DB查询构造器里面的任何方法。

> 注意：
>
> ​	模型类名，建议和表名一致，去掉下划线，采用大驼峰写法【第一个单词的首字母大写】。
>
> ​	例如：
>
> ​		表名为：goods_attribute，则模型类名为：GoodsAttribute

语法：

```
php artisan make:model Models\User
```

![1539220656814](1539220656814.png)

代码如下：

![1539220920594](1539220920594.png)

没有指定表名的情况下会可能会报以下错误：

![1539220860352](1539220860352.png)

> 注意：
>
> ​	Laravel框架中默认情况下，会自动根据模型的单词+s，作为我们当前操作的模型对应的表名，对于我们来说不太适合，所以我们可以通过模型的属性设置表名。例如：protected $table = 'user';

## 3、ORM模型的属性

> `protected  $table`	//设置表名
>
> `protected $primaryKey`	//设置主键字段名 
>
> `public  $timestamps = false;`	    //关闭模型自动管理数据添加时间和更新时间功能
>
> `protected  $fillable = ['字段1', '字段2'...];`   //白名单属性，允许修改的字段列表
>
> `protected  $guarded = ['字段1', '字段2'...];	`    //黑名单属性，不需要修改的字段列表
>
> 注意：$fillable属性和$guarded属性是相反的，所以它们不能同时使用。

## 4、查询数据

### 4.1、查询全部数据

#### 控制器代码

![1539221274140](1539221274140.png)

#### 定义路由

![1539221303338](1539221303338.png)

#### 效果

![1539221235203](1539221235203.png)

### 4.2、查询单条数据

#### 控制器代码

![1539221527055](1539221527055.png)

#### 定义路由

![1539221559245](1539221559245.png)

#### 效果

![1539221492173](1539221492173.png)

## 5、添加数据

> 在模型中添加数据可以使用DB查询构造器提供的==insert==和==insertGetId==方法。
>
> 除了上面两个方法以外，模型也提供了save和create方法。

```
注意：
	Laravel框架中的模型在添加、编辑数据的时候，会帮我们自动更新数据表中的created_at和updated_at字段的数据。
	
created_at和updated_at字段的数据类型是timestamp。

添加数据的时候，模型会自动帮我们填写created_at字段的值与updated_at字段的值。
更新数据的时候，模型会自动帮我们填写updated_at字段的值。

所以，当我们使用模型添加、更新数据的时候，如果表中没有created_at和updated_at这两个字段，则直接报错。
如果需要这两字段，则直接在表中新增字段即可。
```

### 5.1、save添加数据

#### 控制器代码

![1539221781913](1539221781913.png)

#### 定义路由

![1539221834620](1539221834620.png)

#### 效果

![1539222008914](1539222008914.png)

可能会报以下错误

![1539221876407](1539221876407.png)

> 注意：
>
> ​	以上错误信息提示数据表中没有created_at与updated_at字段

解决方案:

1、设置不自动维护这两字段

![1539221945891](1539221945891.png)

2、在数据中增加这两个字段

![1539221991720](1539221991720.png)

### 5.2、create添加数据

#### 控制器代码

![1539222158460](1539222158460.png)

#### 定义路由

![1539222209398](1539222209398.png)

#### 效果

![1539222383958](1539222383958.png)

![1539222400678](1539222400678.png)

> 注意：
>
> ​	使用ORM模型中的create方法添加数据时必须要填写白名单，否则会报以下错误

![1539222239759](1539222239759.png)

在模型中设置白名单

![1539222328806](1539222328806.png)

## 6、更新数据

> 在ORM模型中更新数据，Laravel框架为我们提供了update与save方法。
>
> update是DB查询构造器的方法，所以在模型这里还是原来的操作方式。

### 6.1、save方法更新数据

#### 控制器代码

![1539222706056](1539222706056.png)

#### 定义路由

![1539222734902](1539222734902.png)

#### 效果

![1539222683927](1539222683927.png)

### 6.2、update方法更新数据

#### 控制器代码

![1539223016440](1539223016440.png)

#### 定义路由

![1539222992637](1539222992637.png)

#### 效果

![1539222966056](1539222966056.png)

## 7、删除数据

> Laravel框架中为我们提供了delete与destroy方法来删除数据

### 7.1、delete方法删除数据

#### 控制器代码

![1539224407015](1539224407015.png)

#### 定义路由

![1539224429633](1539224429633.png)

#### 效果

![1539224355041](1539224355041.png)

### 7.2、destroy方法删除数据

#### 控制器代码

![1539224605670](1539224605670.png)

#### 定义路由

![1539224581981](1539224581981.png)

#### 效果

![1539224558158](1539224558158.png)

## 8、软删除

> 在实际开发过程中，数据是无价的，对于现在的存储空间而言，宁愿多使用硬盘存储数据，也不愿意轻易删除。所以，Laravel框架中的模型内置了一个软删除功能，这个功能的使用，需要准备两样东西。
>
> 1.数据表中必须要有deleted_at字段，字段数据类型是timestamp
>
> 2.数据模型文件中，引入软件删除功能类组件softDeleteds

先在我们的user表中添加deleted_at字段，类型为timestamp

![1539224791107](1539224791107.png)

### 1、在模型中引入软件删除类

![1539224850283](1539224850283.png)

### 2、删除数据

#### 控制器代码

![1539225043139](1539225043139.png)

#### 定义路由

![1539225009967](1539225009967.png)

#### 效果

![1539224986355](1539224986355.png)

![1539224978474](1539224978474.png)

### 3、获取被软件删除数据

开文档：https://laravelacademy.org/post/6979.html

#### 控制器代码

![1539225352786](1539225352786.png)

#### 定义路由

![1539225380984](1539225380984.png)

#### 效果

![1539225397965](1539225397965.png)

> 注意：
>
> ​	一旦开启了软件删除，我们之前所学的所有的查询方式都是只能查询正常的数据，被软删除的数据，查不出来的。
>
> ​	如果想查询所有数据(同时包含被软件删除后的数据)，需要在查询的时候，调用withTrashed方法
>
> ​	如果只希望查询被软件删除的数据，则调用onlyTrashed即可，正常数据是不会被查询出来。



# 二、==关联模型==

## 1、简介

​	关联模型主要是通过关系型数据库的主外键【foreign key】来声明两个模型之间的关系，通过模型的关系实现连表查询效果。

​	一个模型对应一个数据表，在关系型数据库中，表与表之间可以因为主外键的关系来确定两个表的关系。

**关系：**

一 对 一

一 对 多

多 对 多

上面这三种关系，我们也可以通过模型的属性进行关联。

在以往的开发中，我们连表操作都是通过SQL语句的join来实现。

但是，这种实现的方式，在多表查询的时候，**很容易出现字段冲突**。

而Laravel框架中的模型，提供了关联模型的功能，通过这个功能可以实现多表查询，同时还可以完美避免多表之间的字段冲突问题。

## 2、使用关联模型进行多表操作

> 关联模型的操作主要分两步：
>
> 1.在模型文件中声明当前模型与其他模型的关系(一对一、一对多、多对多)
>
> Laravel框架中的模型，提供了以下方法来声明模型的关系
>
> `hasOne`	用于 一对一、多对一的场合
>
> `belongsTo`	用于多对一、一对多的场合
>
> `hasMany`	用于多对一、两个多对一就是多对多
>
> 2.在模型以外其他地方使用模型关系来进行多表关联操作

### 2.1、新建comment模型

```cmd
php artisan make:model Models\Comment
```

![1539225638685](1539225638685.png)

代码如下：

![1539225697321](1539225697321.png)

### 2.2、在user模型中声明关联关系

#### user模型代码

![1539225808342](1539225808342.png)

#### 控制器代码

![1539226423597](1539226423597.png)

#### 定义路由

![1539226393720](1539226393720.png)

#### 效果

![1539226364149](1539226364149.png)

### 2.3、在comment模型中声明关联关系

#### comment模型代码

![1539227822279](1539227822279.png)

#### 控制器代码

![1539227995642](1539227995642.png)

#### 定义路由

![1539228024125](1539228024125.png)

#### 效果

![1539227963342](1539227963342.png)

### 2.4、使用with调用关联模型

#### 控制器代码

![1539228293116](1539228293116.png)

#### 效果

![1539228308271](1539228308271.png)

### 2.5、关联模型指定需要获取字段

![1539228497241](1539228497241.png)

#### 效果

![1539228512319](1539228512319.png)



# 三、==模板继承==

## 1、先创建common.blade.php模板文件

resources/views/admin

![1539248316135](1539248316135.png)

## 2、写入内容

把index/index.blade.php文件代码复制到common.blade.php文件

![1539248631148](1539248631148.png)

## 3、其他模板继承公共模板

resources/views/admin/index/index.blade.php

![1539248821837](1539248821837.png)

resources/views/admin/admin/index.blade.php

![1539249139983](1539249139983.png)



# 四、案例：管理员管理模块

## 1、项目分析

1. 管理员的添加

2. 管理员的列表

3. 管理员的删除

4. 管理员的编辑

5. 管理员的登陆与退出

## 2、初始化项目

### 2.1、新建项目

切换镜像源：

```cmd
composer config -g repo.packagist composer https://packagist.laravel-china.org
```

![1539228610128](1539228610128.png)

下载Laravel框架代码

```cmd
composer create-project --prefer-dist laravel/laravel project31 5.4.*
```

![1539228761902](1539228761902.png)

![1539228789365](1539228789365.png)

### 2.2、新建数据库

```sql
CREATE DATABASE `project31` CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_general_ci';
```

![1539228883503](1539228883503.png)

### 2.3、配置数据库

`.env`

![1539228968652](1539228968652.png)

### 2.4、删除一些不必要的文件

Laravel内置的欢迎页面 resource/views/welcome.blade.php

![1539229037997](1539229037997.png)

Laravel内置的Auth控制器目录  app/Http/Controllers/Auth目录

![1539229087135](1539229087135.png)

Laravel内置的数据迁移文件 database/migrations目录下的文件

![1539229174825](1539229174825.png)

### 2.5、配置智能提示插件

https://packagist.org/packages/barryvdh/laravel-ide-helper

#### 2.5.1、下载插件

```cmd
composer require barryvdh/laravel-ide-helper ^2.4.3
```

![1539229287179](1539229287179.png)

#### 2.5.2、 配置config/app.php

```php
'providers' => [
    // ...
    Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class,
],
```

![1539229339735](1539229339735.png)

#### 2.5.3、生成_ide_helper.php文件

```cmd
php artisan ide-helper:generate
```

![1539229370272](1539229370272.png)

### 2.6、运行项目

```cmd
php artisan serve
```

![1539229399113](1539229399113.png)

## 3、完成后台首页功能

### 3.1、新建控制器

```cmd
php artisan make:controller Admin\IndexController
```

![1539229754652](1539229754652.png)

创建控制器的时候有可能提示以下错误信息：

![1539229850970](1539229850970.png)

> 注意：
>
> ​	提示该控制器已经存在

代码如下：

![1539230028577](1539230028577.png)

### 3.2、定义路由

![1539230161454](1539230161454.png)

### 3.3、视图

#### 3.3.1、复制视图文件

将视图文件复制到resources/views/admin/index目录下，并修改后缀为.blade.php

![1539230248616](1539230248616.png)

#### 3.3.2、复制静态资源文件

将静态资源文件复制到public/back目录。注意：没有的目录需要手动创建

![1539230363852](1539230363852.png)

#### 3.3.3、修改静态资源路径

![1539240017542](1539240017542.png)

效果如下：

![1539240029240](1539240029240.png)

## 4、完成欢迎页面功能

### 4.1、定义方法

![1539240102167](1539240102167.png)

### 4.2、定义路由

![1539240167103](1539240167103.png)

### 4.3、视图

#### 4.3.1、复制视图文件

将视图文件复制到resources/views/admin/index目录下，并修改后缀为.blade.php

![1539240245174](1539240245174.png)

#### 4.3.2、修改静态资源路径

![1539240402195](1539240402195.png)

效果如下：

![1539240356606](1539240356606.png)

#### 4.3.3、修改后台首页

修改resources/views/admin/index/index.blade.php文件，代码如下

![1539240529985](1539240529985.png)

效果如下：

![1539240486485](1539240486485.png)

## 5、显示管理员列表页

> 开发步骤
>
> 1. 数据表的创建
>
> 2. 创建控制器【资源控制器】
>
> 3. 创建数据模型【模型】
> 4. 定义路由
> 5. 视图

### 1、创建数据表

```sql
CREATE TABLE `admin`  (
  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `username` varchar(150) NOT NULL COMMENT '登录帐号',
  `password` varchar(255) NOT NULL COMMENT '登录密码',
  `avatar` varchar(255) NULL DEFAULT NULL COMMENT '头像',
  `sex` tinyint(4) NULL DEFAULT 1 COMMENT '性别(1:男,2:女)',
  `nickname` varchar(100) NULL DEFAULT NULL COMMENT '昵称',
  `phone` char(15) NOT NULL COMMENT '手机号码',
  `email` varchar(150) NOT NULL COMMENT '邮箱地址',
  `role_id` tinyint(4) NULL DEFAULT NULL COMMENT '角色ID',
  `note` text NULL COMMENT '备注',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  `disabled_at` timestamp NULL DEFAULT NULL COMMENT '禁用时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `username`(`username`) USING BTREE,
  UNIQUE INDEX `phone`(`phone`) USING BTREE,
  UNIQUE INDEX `email`(`email`) USING BTREE
) ENGINE = InnoDB COMMENT = '管理员表';
```

![1539240670098](1539240670098.png)

### 2、创建控制器(资源控制器)

> 手册：  Laravel >> HTTP层 >> 控制器 >> 资源控制器

```cmd
php artisan make:controller Admin\AdminController --resource
```

![1539240711731](1539240711731.png)

代码如下：

![1539240747633](1539240747633.png)

```
Laravel会为资源控制器创建7个方法，用于操作数据的增删查改；资源控制器就是为了解决命名不统一的问题而设置一种遵循了restFul接口编程命名规范的方法名。
index	用于展示数据列表【只能使用get方式访问】
show	用于展示一条数据【只能使用get方式访问】
create	用于显示添加表单页面【只能使用get方式访问】
store	用于添加(保存)数据【只能使用post方式访问，接收create页面post提交过来的数据】
edit	用于显示编辑表单页面【只能使用get方式访问】
update	用于更新数据【只能使用put方式访问，接收edit页面post提交过来的数据】
destroy	用于删除数据【只能使用delete方式访问，用于删除数据】
```

### 3、创建模型

```cmd
php artisan make:model Models\Admin
```

![1539240811146](1539240811146.png)

代码如下：

![1539241012110](1539241012110.png)

### 4、定义路由(声明资源路由)

```php
语法：Route::resource('地址', '控制器类名');
```

> 注意：
>
> ​	第二个参数不需要加方法名称
>
> 手册：  Laravel >> HTTP层 >> 控制器 >> 资源控制器

![1539241082942](1539241082942.png)

当我们在路由文件中声明了资源路由，则Laravel会自动生成7个对应着资源控制器的路由地址，通过在命令行中使用 `php artisan route:list` 可以查看：

![1539241165058](1539241165058.png)

### 5、视图

#### 5.1、复制视图文件

复制到resources/views/admin/admin目录中。注意：如果目录不存在，需要手动创建。

![1539241247607](1539241247607.png)

#### 5.2、修改静态资源路径

![1539241366025](1539241366025.png)

#### 5.3、载入视图文件

修改app/Http/Controllers/Admin/AdminController.php文件中的index方法，代码如下：

![1539241434346](1539241434346.png)

效果如下：

![1539241481388](1539241481388.png)

#### 5.4、修改添加管理员按钮

![1539241577740](1539241577740.png)

## 6、完成管理员添加功能

> 开发步骤
>
> 1. 控制器代码
>
> 2. 视图
>
> 3. 控制器中接收表单信息
>    1. 验证数据【Validation验证类验证数据】
>    2. 文件上传
>
> 4. 控制器中调用模型保存数据
>    1. 验证数据成功，则保存数据，并跳转到管理员列表
>    2. 验证数据失败，则返回错误信息，并跳转到上一页

### 1、控制器代码

app/Http/Controllers/Admin/AdminController.php

![1539241759395](1539241759395.png)

### 2、视图

#### 2.1、复制视图文件

复制视图文件到resources/views/admin/admin目录中，并重命名

![1539241809540](1539241809540.png)

#### 2.2、修改静态资源路径

![1539242147644](1539242147644.png)

效果如下：

![1539242163589](1539242163589.png)

#### 2.3、调整添加管理员的表单信息

新增两个输入框，分别是昵称和头像，模板代码如下：

![1539242289384](1539242289384.png)

效果

![1539242305900](1539242305900.png)

#### 2.4、修改表单name属性与form提交 

![1539242574719](1539242574719.png)

![1539242618902](1539242618902.png)

![1539242660461](1539242660461.png)

![1539242709799](1539242709799.png)

> 注意：
>
> ​	Laravel框架中除了get请求类型不需要设置token值，其它都必须设置，可以使用以下两种方法：
>
> ​	{{csrf_field()}}
>
> ​	<input type="hidden" name="_token" value="{{csrf_token()}}">

### 3、控制器中接收表单信息

> 默认情况下，我们使用工匠指令生成的控制器都已经自动引入了Request请求操作类，所以我们直接使用all方法接收所有参数即可。

#### 3.1、控制器代码

app/Http/Controllers/Admin/AdminController.php

![1539244010121](1539244010121.png)

效果

![1539243989657](1539243989657.png)

#### 3.2、验证数据[Validation验证数据]

> 使用Validation验证数据，有三种方式：
>
> 1. 通过当前控制器对象的validate方法来使用
>
> 2. 通过Validator静态类来使用(==我们这里使用第二种==)
>
> 3. 通过Request请求操作类来使用(第三种验证方式的时候，类似于第二种)

##### 3.2.1、控制器代码

![1539244897194](1539244897194.png)

![1539244977699](1539244977699.png)

##### 3.2.2、视图

使用layer弹框显示错误信息，官网地址：http://layer.layui.com

resources/views/admin/admin/add.blade.php

第一种：错误需要PHP代码处理

![1539247545172](1539247545172.png)

第二种

![1539247736095](1539247736095.png)

提交表单数据时，有可能报以下错误：

![1539245095555](1539245095555.png)

> 注意：
>
> ​	因为没有引入jquery.form.js文件

引入jquery.form.js文件

![1539245213551](1539245213551.png)

效果如下：

![1539247753919](1539247753919.png)

#### 3.3、数据入库

引入模型类

![1539247806676](1539247806676.png)

实例化

![1539247843981](1539247843981.png)

数据入库

![1539248018557](1539248018557.png)

效果如下：

![1539248175982](1539248175982.png)




